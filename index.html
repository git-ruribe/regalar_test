<!DOCTYPE html>
<html lang="en">
    <head>
		<title>Experiencia 0002 v0.1</title>

        <link rel="stylesheet" href="https://use.typekit.net/oep8ygu.css"> 

    </head>

    <body>
		<div id="info">
			Personaliza la Experiencia 0002
            <p></p>
            <label for="title">Title</label>
            <input type="text" id="title">
            <p></p>
            <p></p>
            <label for="line1">1st Row</label>
            <input type="text" id="line1">
            <p></p>
            <p></p>
            <label for="line2">2nd Row</label>
            <input type="text" id="line2">
            <p></p>
            <p></p>
            <label for="line3">3rd Row</label>
            <input type="text" id="line3">
            <p></p>
            <p></p>
            <label for="line4">4th Row</label>
            <input type="text" id="line4">
            <p></p>
            <p></p>
            <label for="footer">Footer</label>
            <input type="text" id="footer">
            <p></p>
            <button id="tarjeta" class="btn btn-primary">Genera Tarjeta</button>
            <br>
            <p></p>
            <p></p>
            <button id="blob" class="btn btn-primary">Genera Regalo</button>
            <br>
            <p></p>
            <p></p>
            <button hidden id="descarga" class="btn btn-primary">Descargar Regalo</button>
            <br>
            <p></p>
            <p></p>
            <a id="usdzPlacer" rel="" href="">
                <img id="imagen" src="./USDC/0/Material_baseColor.png" width="512" height="512" style="-webkit-transform: scaleY(-1);
                transform: scaleY(-1);">
            </a>
            
            <p></p>
            <p></p>
            <canvas hidden id="canvas" width="512" height="512">
		</div>


        <script type="module">

			import './jszip/jszip.js';
        </script>

        <script>

            /*
            function createCanvas(width, height, set2dTransform = true) {
                const ratio = Math.ceil(window.devicePixelRatio);
                const canvas = document.createElement('canvas');
                canvas.width = width * ratio;
                canvas.height = height * ratio;
                canvas.style.width = `${width}px`;
                canvas.style.height = `${height}px`;
                if (set2dTransform) {
                    canvas.getContext('2d').setTransform(ratio, 0, 0, ratio, 0, 0);
                }
                return canvas;
            }

            var newCanvas = createCanvas(512,512)
            */

            async function addTextToImage(imagePath, text0, text1="", text2="", text3="", text4="", text5="", x=242, y=367, weight="600", fontsize0="48", fontsize1="30", fontsize2="36", fontfamily="medusa", align="center") {
                return new Promise(resolve =>{
                var circle_canvas = document.getElementById("canvas");
                //var circle_canvas = newCanvas
                var context = circle_canvas.getContext("2d");


                circle_canvas.style.width = "512px"
                circle_canvas.style.height = "512px"

                circle_canvas.width = 1024
                circle_canvas.height = 1024

                // Draw Image function
                var img = new Image();
                img.src = imagePath;
                img.onload = function () {
                    context.scale(2,2)
                    context.drawImage(img, 0, 0);
                    context.lineWidth = 1;
                    context.fillStyle = "#000000";
                    context.lineStyle = "#000000";
                    context.textAlign = align
                    context.scale(1,-1)
                    context.font = weight + " normal "+ fontsize0 +"px "+ fontfamily +",sans-serif";
                    context.fillText(text0, x, -y);
                    context.font = weight + " normal "+ fontsize1 +"px "+ fontfamily +",sans-serif";
                    context.fillText(text1, x, -y+74);
                    context.font = weight + " normal "+ fontsize1 +"px "+ fontfamily +",sans-serif";
                    context.fillText(text2, x, -y+110);
                    context.font = weight + " normal "+ fontsize1 +"px "+ fontfamily +",sans-serif";
                    context.fillText(text3, x, -y+146);
                    context.font = weight + " normal "+ fontsize1 +"px "+ fontfamily +",sans-serif";
                    context.fillText(text4, x, -y+182);
                    context.font = weight + " normal "+ fontsize2 +"px "+ fontfamily +",sans-serif";
                    context.fillText(text5, x, -y+250);
                    context.restore();
                    
                    //console.log(context.font);
                    resolve()
                };
            })}

            async function titlechange() {

                document.getElementById("descarga").hidden = true;
                
                var text0 = document.getElementById("title").value;
                var text1 = document.getElementById("line1").value;
                var text2 = document.getElementById("line2").value;
                var text3 = document.getElementById("line3").value;
                var text4 = document.getElementById("line4").value;
                var text5 = document.getElementById("footer").value;

                imagePath = "./USDC/0/Material_baseColor.png"
                console.log(text0);
                await addTextToImage(imagePath, text0, text1=text1, text2=text2, text3=text3, text4=text4, text5=text5)

                var canvas = document.getElementById("canvas");
                var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");  // here is the most important part because if you dont replace you will get a DOM 18 exception.

                //console.log(image);

                var element = document.getElementById("imagen");
                element.src = image

                
            }

            var element = document.getElementById("blob");
                element.onclick = function(event) {
                    generaUSDZ_C()
                console.log(event);
            }

            var element = document.getElementById("tarjeta");
                element.onclick = function(event) {
                    titlechange()
                console.log(event);
            }


            function downloadX(data, filename, type) {
                var file = new Blob([data], {type: type});
                if (window.navigator.msSaveOrOpenBlob) // IE10+
                    window.navigator.msSaveOrOpenBlob(file, filename);
                else { // Others
                    var a = document.createElement("a"),
                            url = URL.createObjectURL(file);
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(function() {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);  
                    }, 0); 
                }
            }
            
            function loadBlob(filePath) {
                return new Promise(resolve =>{
                    var result = null;
                    var xmlhttp = new XMLHttpRequest();
                    xmlhttp.open("GET", filePath, true);
                    xmlhttp.responseType = "arraybuffer";

                    xmlhttp.onload = function (oEvent) {
                        var arrayBuffer = xmlhttp.response;

                        resolve(arrayBuffer)
                    }
                    
                    xmlhttp.send(null);
                }
                )
            }

            async function generaUSDZ_C() {

                document.getElementById("blob").disabled = true
                document.getElementById("tarjeta").disabled = true
                document.getElementById("descarga").hidden = true;

                var canvas = document.getElementById("canvas");
                //canvas = newCanvas
                var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");  // here is the most important part because if you dont replace you will get a DOM 18 exception.

                var zip2 = new JSZip();
                zip2.file("regalar.usdc",await loadBlob("./USDC/exp0002.usdc"))

                zip2.file("0/Material.001_baseColor.png", await loadBlob(image))
                zip2.file("0/05_Colibri_Bird_Body_baseColor.jpg", await loadBlob("./USDC/0/05_Colibri_Bird_Body_baseColor.jpg"))
                zip2.file("0/Material_baseColor.png", await loadBlob("./USDC/0/Material_baseColor.png"))
                zip2.file("0/Material.001_baseColor.jpg", await loadBlob("./USDC/0/Material.001_baseColor.jpg"))
                zip2.file("0/Material.001_metallicRoughness_metal_scale0.jpg", await loadBlob("./USDC/0/Material.001_metallicRoughness_metal_scale0.jpg"))
                zip2.file("0/Material.001_metallicRoughness_occl.jpg", await loadBlob("./USDC/0/Material.001_metallicRoughness_occl.jpg"))
                zip2.file("0/Material.001_metallicRoughness_rough_scale2.jpg", await loadBlob("./USDC/0/Material.001_metallicRoughness_rough_scale2.jpg"))
                zip2.file("0/Material.002_baseColor.jpg", await loadBlob("./USDC/0/Material.002_baseColor.jpg"))
                zip2.file("0/Material.002_metallicRoughness_metal_scale0.jpg", await loadBlob("./USDC/0/Material.002_metallicRoughness_metal_scale0.jpg"))
                zip2.file("0/Material.002_metallicRoughness_occl.jpg", await loadBlob("./USDC/0/Material.002_metallicRoughness_occl.jpg"))
                zip2.file("0/Material.002_metallicRoughness_rough_scale1.jpg", await loadBlob("./USDC/0/Material.002_metallicRoughness_rough_scale1.jpg"))
                zip2.file("0/Material.004_baseColor.jpg", await loadBlob("./USDC/0/Material.004_baseColor.jpg"))
                zip2.file("0/Material.005_baseColor.jpg", await loadBlob("./USDC/0/Material.005_baseColor.jpg"))
                zip2.file("0/Material.005_metallicRoughness_metal_scale0.jpg", await loadBlob("./USDC/0/Material.005_metallicRoughness_metal_scale0.jpg"))
                zip2.file("0/Material.005_metallicRoughness_occl.jpg", await loadBlob("./USDC/0/Material.005_metallicRoughness_occl.jpg"))
                zip2.file("0/Material.005_metallicRoughness_rough_scale3.jpg", await loadBlob("./USDC/0/Material.005_metallicRoughness_rough_scale3.jpg"))
                zip2.file("0/Material.006_baseColor.jpg", await loadBlob("./USDC/0/Material.006_baseColor.jpg"))


                zip2.generateAsync({type:"blob"})
                    .then(function (blob) {
                        const a = document.createElement("a");
                            if (a.relList.supports("ar")) {
                            // AR is available.
                                console.log("AR disponible");

                                var file = new Blob([blob], {type:"model/vnd.usdz+zip"});
                                var url = URL.createObjectURL(file);

                                var elementImagen = document.getElementById("imagen");
                                elementImagen.src = "./USDC/thumb0002.png"

                                var elementAR = document.getElementById("usdzPlacer");
                                elementAR.rel = "ar"
                                elementAR.href = url

                                document.getElementById("blob").disabled = false;
                                document.getElementById("tarjeta").disabled = false;

                                
                                document.getElementById("descarga").onclick = function(event) {
                                    downloadX(blob, "regalAR.usdz", "model/vnd.usdz+zip");
                                }
                                document.getElementById("descarga").hidden = false;

                            } else {
                                console.log("AR NO disponible");

                                downloadX(blob, "regalAR.usdz", "model/vnd.usdz+zip");

                                document.getElementById("blob").disabled = false
                                document.getElementById("tarjeta").disabled = false
                            }
                        //downloadX(blob, "toy2.usdz", "model/vnd.usdz+zip");
                        console.log("OK");
                    });
            }
            


            function loadFile(filePath) {
                var result = null;
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.open("GET", filePath, false);
                xmlhttp.send();
                if (xmlhttp.status==200) {
                    result = xmlhttp.responseText;
                }
            return result;
            }


        </script>


</body>
</html>